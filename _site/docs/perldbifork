<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>perldbifork</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="Jekyll • Simple, blog-aware, static sites - Feed" href="/feed.xml" />
  <link rel="alternate" type="application/atom+xml" title="Recent commits to Jekyll’s master branch" href="https://github.com/king-ming/niumang/commits/master.atom" />
  <link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700,900,100italic,300italic,400italic,700italic,900italic' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Arizonia' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/normalize.css" />
  <link rel="stylesheet" href="/css/gridism.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/pygments.css" />
  <link rel="stylesheet" href="/css/duoshuo.css" />
  <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
  <script type="text/javascript">
 $(document).ready(function(){
     $("article > h1,h2,h3").each(function(i,item){
        var tag = $(item).get(0).localName;
        $(item).attr("id","wow"+i);
        $("#toc").append('<li><a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></li>');
        $(".newh1").css("margin-left",0);
        $(".newh2").css("margin-left",20);
        $(".newh3").css("margin-left",40);
      });
     $("article > h1,h2,h3").each(function(i,item){
        $(item).html('<a href="#wow0">'+$(this).text()+'</a>');
     });
     $("code").each(function(i,item){
        $(item).attr("class","perl");
     });
 });
 </script>

</head>



<body class="wrap">
  <header>
<meta name="baidu-tc-cerfication" content="82c166ea786c5a49a5d130509b92327f" />
  <nav class="mobile-nav show-on-mobiles">
    <ul>
  <li class="">
    <a href="/">Overview</a>
  </li>
  <li class="current">
    <a href="/docs/home/">Doc<span class="show-on-mobiles">s</span><span class="hide-on-mobiles">umentation</span></a>
  </li>
  <li class="">
    <a href="/news/">Blog</a>
  </li>
<!--  <li class="">
    <a href="/news/">News</a>
  </li>
  <li class="">
    <a href="https://github.com/king-ming/niumang"><span class="hide-on-mobiles">View on </span>GitHub</a>
</li>
-->
</ul>

  </nav>
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <h1>
        <a href="/">
          <span>舌尖上的牛氓</span>
          <img src="/img/zh.gif" width="620" height="64" alt="">
        </a>
      </h1>
    </div>
    <nav class="main-nav unit two-thirds hide-on-mobiles">
      <ul>
  <li class="">
    <a href="/">Overview</a>
  </li>
  <li class="current">
    <a href="/docs/home/">Doc<span class="show-on-mobiles">s</span><span class="hide-on-mobiles">umentation</span></a>
  </li>
  <li class="">
    <a href="/news/">Blog</a>
  </li>
<!--  <li class="">
    <a href="/news/">News</a>
  </li>
  <li class="">
    <a href="https://github.com/king-ming/niumang"><span class="hide-on-mobiles">View on </span>GitHub</a>
</li>
-->
</ul>

    </nav>
  </div>
</header>

    <section class="docs">
    <div class="grid">

      <div class="docs-nav-mobile unit whole show-on-mobiles">
  <select onchange="if (this.value) window.location.href=this.value">
    <option value="">Navigate the docs…</option>
    <optgroup label="Getting started">
      


  

  
    
  
    
  
    
      <option value="/docs/home/">perl</option>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    <optgroup label="Your Content">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    <optgroup label="Customization">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    <optgroup label="Deployment">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    <optgroup label="Miscellaneous">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
    <optgroup label="Meta">
      


  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


    </optgroup>
  </select>
</div>


      <div class="unit four-fifths">
        <article>
          <h1>perldbifork</h1>
          <div class='note '>
    <h5>perl DBI fork</h5>
    <p>
    Perl fork,DBI,clone
    </p>
</div><div id='toc'> </div>
<p><br /></p>

<h1 id="">坑</h1>

<p>在之前的一段时间里,因为个人需要我需要对几百万的数据进行 CRUD 操作,鉴于对 AnyEvent::DBI 的靠谱程度不是很信赖,所以 我使用了 fork 多进程来处理的方案,但是实际操作中还是不小心掉了几个坑里,现在总结,防止以后重复掉坑:</p>

<ul>
<li>父子进程共享 dbi 句柄</li>
</ul>

<p>unix 环境下 fork 进程对文件句柄是 share 的,也就是说 dbi 句柄也是共享的,假设我们父进程和子进程同时进行一个 select 的查询,那么恭喜你很可能掉坑里了,例如:</p>

<pre><code># father process
SELECT * FROM foobar WHERE baz = 3

# child process
SELECT grzbaka FROM baz WHERE foo = 5</code></pre>

<p>现在,我们实际的查询可能会变成这样</p>

<pre><code>SELECT * FROSELECT grzbaka FROM baM foobar WHERE baz = 3z WHERE foo = 5</code></pre>

<p>当然实际的情况还是会更复杂的,除非你使用的是 AnyEvent::DBI 或者另外的 POE 之类的事件型模块. 所以争取的代码就是在子进程创建新的 db 链接或者使用 dbh 的 clone 方法:</p>

<pre><code>use DBI;
use strict;
use warnings;

my $pid = fork;
if( $pid ){
    my $dbh = DBI-&gt;connect($dsn,$user,$password);
}else{
    my $child_dbh = DBI-&gt;connect($dsn,$user,$password);
    #or 
    $child_dbh = $dbh-&gt;clone();
}</code></pre>

<p>或者你使用Parallel::ForkManager:</p>

<pre><code># this is just example script
use strict;
use warnings;
use Parallel::ForkManager;
use DBI;

my @links=(1..1000);
my $pm=new Parallel::ForkManager(5);

foreach my $x (0..$#links) {
    $pm-&gt;start and next;
        my $dbh = DBI-&gt;connect(&quot;DBI:mysql:database=customers;host=loca
+lhost;port=3306&quot;, &quot;root&quot;, &quot;&quot;)
        or die &quot;Can't connect: &quot;, $DBI::errstr; 
      $dbh-&gt;{RaiseError} = 1;
    print &quot;$links[$x]\n&quot;;
      # do something (read, update, insert from db)
      undef $dbh;
    $pm-&gt;finish;
}</code></pre>

<ul>
<li>在子进程 undef 掉父进程的 $dbh</li>
</ul>

<p>boy,这是非常危险的操作哦,这会爸父进程的 dbh 也干掉,因为他们并不是彼此的 copy,他们是同一个句柄,实际操作中,我们可以这样做的:</p>

<pre><code>my $child_dbh = $dbh-&gt;clone;
# in child process
$child_dbh-&gt;{InactiveDestroy} =1;
undef $dbh;</code></pre>

<p>InactiveDestroy 这个设置就是告诉 DBI 如果子进程的 dbi 被销毁了,父进程的 dbh 不要关闭.(前提是你这个$dbh 是克隆的句柄)</p>

<h1 id="_2">测试</h1>

<p>为了验证以上诸坑,我从网上 copy 了一段 testmore 的代码</p>

<pre><code>#!/usr/bin/perl

use strict;
use warnings;

use Test::More 'no_plan';
use DBI;

my @connect_parameters
    = ( 'DBI:Pg:dbname=template1', 'user', 'pass',
        { ShowErrorStatement =&gt; 1,
          AutoCommit =&gt; 1,
          RaiseError =&gt; 1,
          PrintError =&gt; 0, } );

# An earlier version leaked socket connections
# and would eventually fail (or cause &quot;Too many
# open files&quot; errors elsewhere).  I loop a while
# here to detect that bug.
foreach my $iteration ( 1 .. 2_000 ) {

    warn &quot;iteration $iteration\n&quot;;

    my $dbh = DBI-&gt;connect( @connect_parameters );
    isa_ok( $dbh, 'DBI::db' );

    my $one;
    ($one) = $dbh-&gt;selectrow_array( 'SELECT 1' );
    is( $one, 1, 'can select 1' );

    # this is fetched later
    my $sth = $dbh-&gt;prepare( 'SELECT 1' );
    $sth-&gt;execute;

    ok( ! $dbh-&gt;{InactiveDestroy},
        'dbh InactiveDestroy is off before fork' );

    my $pid = fork();
    if ( ! defined $pid ) {
        die &quot;Can't fork: $!\n&quot;;
    }

    if ( $pid ) {
        # parent

        isa_ok( $dbh, 'DBI::db' );
    
        ($one) = $dbh-&gt;selectrow_array( 'SELECT 1' );
        is( $one, 1, 'parent can select 1 before child exits' );

        is( wait(), $pid, 'waited for child' );

        ($one) = $dbh-&gt;selectrow_array( 'SELECT 1' );
        is( $one, 1, 'parent can select 1 after child exits' );
    }
    else {
        # child

        my $child_dbh = $dbh-&gt;clone();
        isa_ok( $dbh, 'DBI::db' );
        isa_ok( $child_dbh, 'DBI::db' );

        ok( ! $dbh-&gt;{InactiveDestroy},
            'dbh InactiveDestroy is off in child after fork' );
        ok( ! $child_dbh-&gt;{InactiveDestroy},
            'child_dbh InactiveDestroy is off in child after fork' );

        $dbh-&gt;{InactiveDestroy} = 1;

        ok( $dbh-&gt;{InactiveDestroy},
            'dbh InactiveDestroy is on in child after fork' );
        ok( ! $child_dbh-&gt;{InactiveDestroy},
            'child_dbh InactiveDestroy is off in child after fork' );

        undef $dbh;
        ok( ! $dbh, 'death to dbh in child' );

        ($one) = $child_dbh-&gt;selectrow_array( 'SELECT 1' );
        is( $one, 1, 'child can select 1' );

        exit;
    }

    ($one) = $sth-&gt;fetchrow_array;
    is( $one, 1, 'select running before fork still works' );
}</code></pre>

<p>总而言之,就是处理 dbh fork 的时候要注意句柄是共享的,不是 copy 的.</p>

          <div class="section-nav">
  <div class="left align-right">
    
      <a href="/docs/perlreftut/" class="prev">
        Back
      </a>
    
  </div>
  <div class="right align-left">
    
      <a href="/docs/perlobj/" class="next">
        Next
      </a>
    
  </div>
  <div class="clear"></div>
</div>
<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"niumang"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->


        </article>
      </div>

      <div class="unit one-fifth hide-on-mobiles">
  <aside>
    <h4>perldoc</h4>
    

<ul>

  

  

  
    
  
    
  
    
      <li class=""><a href="/docs/home/">perl</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/perlbook/">perlbook</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/perlintro/">perlintro</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/perlopentut/">perlopentut</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/perllol/">perllol</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/perlreftut/">perlreftut</a></li>
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>CPAN</h4><br>
    <h4>Test</h4>
    <h4>DBI</h4>
    <h4>LWP</h4>
    <h4>Rex</h4>
    <h4>Mojo</h4>
    <h4>Dancer</h4>
    <h4>Dancer</h4>
    <h4>AnyEvent</h4>
    <h4>Coro</h4>
    <h4>POE</h4>
  </aside>
</div>


      <div class="clear"></div>

    </div>
  </section>


  <footer>
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <p>By <a href="http://tom.preston-werner.com">Tom Preston-Werner</a>, <a href="http://quaran.to/">Nick Quaranto</a>, and many more <a href="https://github.com/king-ming/niumang/graphs/contributors">awesome&nbsp;contributors</a>.</p>
    </div>
    <div class="unit two-thirds align-right center-on-mobiles">
      <p>
        Proudly hosted by
        <a href="https://github.com">
          <img src="/img/footer-logo.png" alt="GitHub • Social coding">
        </a>
      </p>
    </div>
  </div>
</footer>

  
  <!-- Gauges (http://gaug.es/) -->
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '503c5af6613f5d0f19000027');
      t.src = '//secure.gaug.es/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>





</body>
</html>
